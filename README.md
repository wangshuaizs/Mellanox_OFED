# MLNX_OFED for collecting throughput

This MLNX_OFED is based on [MLNX_OFED_SRC-debian-4.1-1.0.2.0.tgz](http://www.mellanox.com/downloads/ofed/MLNX_OFED-4.1-1.0.2.0/MLNX_OFED_SRC-debian-4.1-1.0.2.0.tgz). To collect throughput information, some codes, creating a new thread to poll send queue, are added in libmlx4-41mlnx1/src/verbs.c.

(Note: only the traffic sent by the host is collected.)


# Usage

You can choose to install from the [source codes](./MLNX_OFED_SRC-4.1-1.0.2.0) in this repository, or patch the source codes from [Mellanox website](http://www.mellanox.com/downloads/ofed/MLNX_OFED-4.1-1.0.2.0/MLNX_OFED_SRC-debian-4.1-1.0.2.0.tgz) with the patch file [OFED.patch](./OFED.patch). Also, you can choose to replace the related .deb files (i.e., libmlx4-1_41mlnx1-OFED.4.1.0.1.0.41102_amd64.deb, libmlx4-1-dbg_41mlnx1-OFED.4.1.0.1.0.41102_amd64.deb, libmlx4-dev_41mlnx1-OFED.4.1.0.1.0.41102_amd64.deb) in the file [MLNX_OFED_LINUX-4.1-1.0.2.0-ubuntu16.04-x86_64.iso](http://www.mellanox.com/page/mlnx_ofed_eula?mtag=linux_sw_drivers&mrequest=downloads&mtype=ofed&mver=MLNX_OFED-4.1-1.0.2.0&mname=MLNX_OFED_LINUX-4.1-1.0.2.0-ubuntu16.04-x86_64.iso) with those generated by the source code in this repository.

```
sudo ./install.pl
```

Some environment variables have to be set before establishing RDMA connection:

+ __DUMP__ : The flag to signal whether or not to collect traffic information. If not defined by user, traffic information will not be collected. Any value can enable collecting;
+ __DUMP_DIR__ : The path where the log files are located, i.e., "/home/user/log_dir". If not defined by user, the default value is "/tmp";
+ __CORE_ID__ : The core ID used to poll send queue. If not defined by user, no CPU affinity will be set.

# Additions

The file [untar.sh](./tool/untar.sh) is also offered to extract files from all archives.